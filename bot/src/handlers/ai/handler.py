

from aiogram import Router, F
from aiogram.fsm.context import FSMContext
from aiogram.types import CallbackQuery, Message
from aiogram.fsm.state import State, StatesGroup

from src.keyboards.ai_keyboard import (
    ai_settings_kb,
    models_kb,
    confirm_reset_kb,
    back_to_ai_settings_kb,
    cancel_kb,
)
from src.keyboards.inline import admin_menu_kb
from src.utils.ai import (
    get_model,
    set_model,
    get_prompt,
    set_prompt,
    get_all_settings,
    DEFAULT_MODEL,
    DEFAULT_PROMPTS,
    AVAILABLE_MODELS,
)

router = Router()


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# FSM ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

class AISettingsStates(StatesGroup):
    wait_prompt = State()
    wait_custom_model = State()  # ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ° ÑĞ²Ğ¾ĞµĞ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@router.callback_query(F.data == "ai:select_model")
async def select_model_menu(c: CallbackQuery):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°"""
    current = await get_model()
    await c.message.edit_text(
        f"ğŸ¤– <b>Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Claude</b>\n\n"
        f"Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ: <code>{current}</code>\n\n"
        f"Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ· ÑĞ¿Ğ¸ÑĞºĞ° Ğ¸Ğ»Ğ¸ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ²Ğ¾Ñ:",
        reply_markup=models_kb(current),
        parse_mode="HTML"
    )
    await c.answer()


@router.callback_query(F.data.startswith("ai:set_model:"))
async def set_model_handler(c: CallbackQuery):
    """Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½ÑƒÑ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ¸Ğ· ÑĞ¿Ğ¸ÑĞºĞ°"""
    model = c.data.split(":", 2)[2]

    await set_model(model)
    await c.answer(f"âœ… ĞœĞ¾Ğ´ĞµĞ»ÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°!", show_alert=True)

    await c.message.edit_text(
        f"âš™ï¸ <b>ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ AI</b>\n\n"
        f"Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ: <code>{model}</code>\n\n"
        f"Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:",
        reply_markup=ai_settings_kb(),
        parse_mode="HTML"
    )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ’Ğ²Ğ¾Ğ´ ÑĞ²Ğ¾ĞµĞ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@router.callback_query(F.data == "ai:custom_model")
async def custom_model_start(c: CallbackQuery, state: FSMContext):
    """ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ²Ğ²Ğ¾Ğ´ ÑĞ²Ğ¾ĞµĞ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸"""
    await state.set_state(AISettingsStates.wait_custom_model)

    await c.message.edit_text(
        "âœï¸ <b>Ğ’Ğ²Ğ¾Ğ´ ÑĞ²Ğ¾ĞµĞ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸</b>\n\n"
        "ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Claude.\n\n"
        "ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:\n"
        "â€¢ <code>claude-sonnet-4-5-20250929</code>\n"
        "â€¢ <code>claude-haiku-4-5-20251001</code>\n"
        "â€¢ <code>claude-opus-4-5-20251101</code>\n\n"
        "ĞĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸: https://docs.anthropic.com/en/docs/about-claude/models",
        reply_markup=cancel_kb(),
        parse_mode="HTML"
    )
    await c.answer()


@router.message(AISettingsStates.wait_custom_model)
async def save_custom_model(m: Message, state: FSMContext):
    """Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ²Ğ²ĞµĞ´Ñ‘Ğ½Ğ½ÑƒÑ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ"""
    model_name = (m.text or "").strip()

    # Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ
    if not model_name:
        await m.answer("âš ï¸ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸:")
        return

    if len(model_name) < 5:
        await m.answer("âš ï¸ Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸:")
        return

    if len(model_name) > 100:
        await m.answer("âš ï¸ Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ´Ğ»Ğ¸Ğ½Ğ½Ğ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸:")
        return

    # ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ ĞµÑĞ»Ğ¸ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ½Ğµ Ğ¸Ğ· Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¿Ğ¸ÑĞºĞ°
    warning = ""
    if model_name not in AVAILABLE_MODELS and not model_name.startswith("claude-"):
        warning = "\n\nâš ï¸ ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ½Ğµ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶Ğ° Ğ½Ğ° Claude. Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²ĞµÑ€Ğ½Ğ¾Ğµ."

    await set_model(model_name)
    await state.clear()

    await m.answer(
        f"âœ… ĞœĞ¾Ğ´ĞµĞ»ÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°: <code>{model_name}</code>{warning}",
        reply_markup=ai_settings_kb(),
        parse_mode="HTML"
    )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ²
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

MODE_NAMES = {
    "std": "Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹",
    "short": "ĞšĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹",
    "creative": "ĞšÑ€ĞµĞ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹",
}


@router.callback_query(F.data.startswith("ai:edit_prompt:"))
async def edit_prompt_start(c: CallbackQuery, state: FSMContext):
    """ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ°"""
    mode = c.data.split(":")[2]

    if mode not in MODE_NAMES:
        await c.answer("ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼", show_alert=True)
        return

    current_prompt = await get_prompt(mode)
    await state.set_state(AISettingsStates.wait_prompt)
    await state.update_data(mode=mode)

    preview = current_prompt[:1500] if len(current_prompt) > 1500 else current_prompt

    await c.message.edit_text(
        f"ğŸ“ <b>Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ°: {MODE_NAMES[mode]}</b>\n\n"
        f"Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚:\n"
        f"<pre>{_escape_html(preview)}</pre>\n\n"
        f"ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ°:",
        reply_markup=cancel_kb(),
        parse_mode="HTML"
    )
    await c.answer()


@router.message(AISettingsStates.wait_prompt)
async def save_new_prompt(m: Message, state: FSMContext):
    """Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚"""
    data = await state.get_data()
    mode = data.get("mode", "std")

    new_prompt = (m.text or "").strip()
    if len(new_prompt) < 10:
        await m.answer("âš ï¸ ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ (Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 10 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²). ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·:")
        return

    await set_prompt(mode, new_prompt)
    await state.clear()

    preview = new_prompt[:500] if len(new_prompt) > 500 else new_prompt

    await m.answer(
        f"âœ… ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚ <b>{MODE_NAMES.get(mode, mode)}</b> ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½!\n\n"
        f"<pre>{_escape_html(preview)}</pre>",
        reply_markup=ai_settings_kb(),
        parse_mode="HTML"
    )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@router.callback_query(F.data == "ai:show_settings")
async def show_all_settings(c: CallbackQuery):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ AI"""
    settings_data = await get_all_settings()

    text = f"ğŸ“Š <b>Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ AI</b>\n\n"
    text += f"ğŸ¤– <b>ĞœĞ¾Ğ´ĞµĞ»ÑŒ:</b>\n<code>{settings_data['model']}</code>\n\n"

    for mode, prompt in settings_data["prompts"].items():
        name = MODE_NAMES.get(mode, mode)
        preview = prompt
        text += f"ğŸ“ <b>{name}:</b>\n<pre>{_escape_html(preview)}</pre>\n\n"

    await c.message.edit_text(
        text,
        reply_markup=back_to_ai_settings_kb(),
        parse_mode="HTML"
    )
    await c.answer()


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@router.callback_query(F.data == "ai:reset")
async def confirm_reset(c: CallbackQuery):
    """Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ ÑĞ±Ñ€Ğ¾ÑĞ°"""
    await c.message.edit_text(
        "âš ï¸ <b>Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº AI</b>\n\n"
        "Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑĞ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸?\n\n"
        f"ĞœĞ¾Ğ´ĞµĞ»ÑŒ ÑÑ‚Ğ°Ğ½ĞµÑ‚: <code>{DEFAULT_MODEL}</code>\n"
        "Ğ’ÑĞµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑÑ Ğº Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸ÑĞ¼ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ.",
        reply_markup=confirm_reset_kb(),
        parse_mode="HTML"
    )
    await c.answer()


@router.callback_query(F.data == "ai:confirm_reset")
async def do_reset(c: CallbackQuery):
    """Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ ÑĞ±Ñ€Ğ¾Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº"""
    await set_model(DEFAULT_MODEL)

    for mode, prompt in DEFAULT_PROMPTS.items():
        await set_prompt(mode, prompt)

    await c.answer("âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑĞ±Ñ€Ğ¾ÑˆĞµĞ½Ñ‹!", show_alert=True)

    await c.message.edit_text(
        f"âš™ï¸ <b>ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ AI</b>\n\n"
        f"Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ: <code>{DEFAULT_MODEL}</code>\n\n"
        f"Ğ’ÑĞµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑĞ±Ñ€Ğ¾ÑˆĞµĞ½Ñ‹.",
        reply_markup=ai_settings_kb(),
        parse_mode="HTML"
    )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ĞĞ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@router.callback_query(F.data == "ai:back")
async def back_to_ai_settings(c: CallbackQuery, state: FSMContext):
    """Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ² Ğ¼ĞµĞ½Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº AI"""
    await state.clear()

    model = await get_model()
    await c.message.edit_text(
        f"âš™ï¸ <b>ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ AI</b>\n\n"
        f"Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ: <code>{model}</code>\n\n"
        f"Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:",
        reply_markup=ai_settings_kb(),
        parse_mode="HTML"
    )
    await c.answer()


@router.callback_query(F.data == "ai:back_to_admin")
async def back_to_admin_menu(c: CallbackQuery, state: FSMContext):
    """Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ² Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºĞ¸"""
    await state.clear()
    await c.message.edit_text("ĞĞ´Ğ¼Ğ¸Ğ½ĞºĞ°:", reply_markup=admin_menu_kb())
    await c.answer()


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def _escape_html(text: str) -> str:
    return (
        text
        .replace("&", "&amp;")
        .replace("<", "&lt;")
        .replace(">", "&gt;")
    )